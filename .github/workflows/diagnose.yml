name: Diagnose Build

on:
  workflow_dispatch:

jobs:
  diagnose:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'

    - name: Setup Android SDK
      uses: android-actions/setup-android@v3

    - name: Check project structure
      run: |
        echo "=== Project Structure ==="
        ls -la
        echo ""
        echo "=== Gradle files ==="
        find . -name "gradlew" -o -name "build.gradle*" -o -name "settings.gradle*"
        echo ""
        echo "=== Source files ==="
        find . -name "*.kt" -o -name "*.java" | head -20

    - name: Check Gradle wrapper
      run: |
        echo "=== Gradle Wrapper Properties ==="
        cat gradle/wrapper/gradle-wrapper.properties || echo "No gradle-wrapper.properties found"
        echo ""
        echo "=== Gradle Version ==="
        ./gradlew --version || echo "Gradle wrapper not working"

    - name: Check Android manifest
      run: |
        echo "=== Android Manifest ==="
        cat app/src/main/AndroidManifest.xml || echo "No AndroidManifest.xml found"

    - name: Check dependencies
      run: |
        echo "=== Checking build.gradle.kts ==="
        cat app/build.gradle.kts || echo "No build.gradle.kts found"
        echo ""
        echo "=== Checking settings.gradle.kts ==="
        cat settings.gradle.kts || echo "No settings.gradle.kts found"

    - name: Dry run Gradle tasks
      run: ./gradlew tasks --all || echo "Gradle tasks failed"
      continue-on-error: true